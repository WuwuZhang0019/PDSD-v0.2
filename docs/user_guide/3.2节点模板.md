# 节点模板（NodeTemplate）定义

本文档定义了PDSD项目中电气系统专用的节点类型模板，用于标准化节点创建、分类管理和属性预配置。

## 节点模板定义

```rust
use egui_node_graph::{NodeTemplateTrait, InputParamKind};

// 定义电气系统节点模板枚举
#[derive(Debug, Clone, Copy, PartialEq)]
enum ElectricNodeTemplate {
    // 配电回路相关节点
    CircuitNode,
    CircuitGroupNode,

    // 配电箱相关节点
    DistributionBoxNode,
    MainDistributionBoxNode,
    SubDistributionBoxNode,

    // 干线系统图相关节点
    MainLineNode,
    FeederLineNode,

    // 电源节点
    PowerSourceNode,

    // 计算节点
    CurrentCalculationNode,
    PhaseBalanceNode,
}

// 实现CategoryTrait以支持节点分类
impl egui_node_graph::CategoryTrait for ElectricNodeTemplate {
    fn category(&self) -> &str {
        match self {
            ElectricNodeTemplate::CircuitNode |
            ElectricNodeTemplate::CircuitGroupNode => "配电回路",

            ElectricNodeTemplate::DistributionBoxNode |
            ElectricNodeTemplate::MainDistributionBoxNode |
            ElectricNodeTemplate::SubDistributionBoxNode => "配电箱",

            ElectricNodeTemplate::MainLineNode |
            ElectricNodeTemplate::FeederLineNode => "干线系统",

            ElectricNodeTemplate::PowerSourceNode => "电源",

            ElectricNodeTemplate::CurrentCalculationNode |
            ElectricNodeTemplate::PhaseBalanceNode => "计算工具",
        }
    }
}

// 实现NodeTemplateTrait以定义如何构建节点
impl NodeTemplateTrait for ElectricNodeTemplate {
    type NodeData = ElectricNodeData;
    type DataType = ElectricDataType;
    type ValueType = ElectricValueType;
    type Category = Self;
    type UserState = (); // 可以使用自定义类型存储用户状态

    fn node_label(&self) -> String {
        match self {
            ElectricNodeTemplate::CircuitNode => "配电回路",
            ElectricNodeTemplate::CircuitGroupNode => "回路组",
            ElectricNodeTemplate::DistributionBoxNode => "配电箱",
            ElectricNodeTemplate::MainDistributionBoxNode => "总配电箱",
            ElectricNodeTemplate::SubDistributionBoxNode => "分配电箱",
            ElectricNodeTemplate::MainLineNode => "干线",
            ElectricNodeTemplate::FeederLineNode => "馈线",
            ElectricNodeTemplate::PowerSourceNode => "电源",
            ElectricNodeTemplate::CurrentCalculationNode => "电流计算",
            ElectricNodeTemplate::PhaseBalanceNode => "三相平衡",
        }
    }

    fn node_category(&self) -> Self::Category {
        *self
    }

    fn user_data(&self) -> Self::NodeData {
        // 使用UUID::new_v4()生成临时ID
        let temp_id = uuid::Uuid::new_v4();
        self.node_data(temp_id)
    }

    fn node_data(&self, id: uuid::Uuid) -> Self::NodeData {
        let mut node_data = ElectricNodeData::new_with_id(id);

        // 根据模板类型设置节点数据
        match self {
            ElectricNodeTemplate::CircuitNode => {
                node_data.node_type = ElectricNodeType::CircuitNode;
                node_data.specific_data = ElectricNodeSpecificData::Circuit(CircuitInfo {
                    id: format!("CIR-{}", id.to_string().split('-').next().unwrap()),
                    name: "配电回路".to_string(),
                    power: 0.0,
                    power_factor: 0.8,
                    coefficient: 0.8,
                    phase: "A".to_string(),
                    calculated_current: 0.0,
                });
                node_data.size = egui::Vec2::new(200.0, 150.0);
            },

            ElectricNodeTemplate::DistributionBoxNode |
            ElectricNodeTemplate::MainDistributionBoxNode |
            ElectricNodeTemplate::SubDistributionBoxNode => {
                node_data.node_type = ElectricNodeType::DistributionBoxNode;
                let box_type_name = match self {
                    ElectricNodeTemplate::MainDistributionBoxNode => "总配电箱",
                    ElectricNodeTemplate::SubDistributionBoxNode => "分配电箱",
                    _ => "配电箱",
                };
                node_data.specific_data = ElectricNodeSpecificData::DistributionBox(DistributionBoxInfo {
                    id: format!("DB-{}", id.to_string().split('-').next().unwrap()),
                    name: box_type_name.to_string(),
                    incoming_power: 0.0,
                    incoming_current: 0.0,
                    phase_balance: PhaseBalanceInfo {
                        phase_a_power: 0.0,
                        phase_b_power: 0.0,
                        phase_c_power: 0.0,
                        balance_degree: 0.0,
                    },
                    outgoing_circuits_count: 0,
                });
                node_data.size = egui::Vec2::new(220.0, 200.0);
            },

            ElectricNodeTemplate::MainLineNode |
            ElectricNodeTemplate::FeederLineNode => {
                node_data.node_type = ElectricNodeType::MainLineNode;
                let line_type_name = match self {
                    ElectricNodeTemplate::MainLineNode => "干线",
                    _ => "馈线",
                };
                node_data.specific_data = ElectricNodeSpecificData::MainLine(MainLineInfo {
                    id: format!("ML-{}", id.to_string().split('-').next().unwrap()),
                    name: line_type_name.to_string(),
                    voltage_level: 0.4, // 默认0.4kV
                    total_power: 0.0,
                    current_calculated: 0.0,
                    cable_type: "YJV-0.6/1kV".to_string(),
                    cable_length: 0.0,
                    resistance: 0.0,
                    reactance: 0.0,
                });
                node_data.size = egui::Vec2::new(240.0, 220.0);
            },

            _ => {
                // 默认配置
            }
        }

        node_data
    }

    fn build_node(
        &self,
        graph: &mut egui_node_graph::Graph<Self::NodeData, Self::DataType, Self::ValueType>,
        _user_state: &mut Self::UserState,
        node_id: egui_node_graph::NodeId,
    ) {
        // 根据节点类型添加输入输出参数
        match self {
            ElectricNodeTemplate::CircuitNode => {
                // 配电回路节点：一个输入（上级电源），多个输出（功率、电流、回路数据）
                graph.add_input_param(node_id, "上级电源", InputParamKind::ConnectionOnly, ElectricDataType::Voltage, None);
                graph.add_output_param(node_id, "功率", ElectricDataType::Power);
                graph.add_output_param(node_id, "电流", ElectricDataType::Current);
                graph.add_output_param(node_id, "回路数据", ElectricDataType::CircuitData);
            },

            ElectricNodeTemplate::DistributionBoxNode |
            ElectricNodeTemplate::MainDistributionBoxNode |
            ElectricNodeTemplate::SubDistributionBoxNode => {
                // 配电箱节点：一个输入（上级进线），多个输出（出线电流、三相平衡、配电箱数据）
                graph.add_input_param(node_id, "上级进线", InputParamKind::ConnectionOnly, ElectricDataType::Current, None);
                graph.add_output_param(node_id, "出线电流", ElectricDataType::Current);
                graph.add_output_param(node_id, "三相平衡", ElectricDataType::PhaseBalance);
                graph.add_output_param(node_id, "配电箱数据", ElectricDataType::DistributionBoxData);
            },

            ElectricNodeTemplate::MainLineNode |
            ElectricNodeTemplate::FeederLineNode => {
                // 干线节点：一个输入（电源输入），多个输出（线路电流、电压降、干线数据）
                graph.add_input_param(node_id, "电源输入", InputParamKind::ConnectionOnly, ElectricDataType::Voltage, None);
                graph.add_output_param(node_id, "线路电流", ElectricDataType::Current);
                graph.add_output_param(node_id, "电压降", ElectricDataType::Voltage);
                graph.add_output_param(node_id, "干线数据", ElectricDataType::MainLineData);
            },

            ElectricNodeTemplate::PowerSourceNode => {
                // 电源节点：无输入，输出电压和电源信息
                graph.add_output_param(node_id, "电压", ElectricDataType::Voltage);
                graph.add_output_param(node_id, "电源容量", ElectricDataType::Power);
            },

            ElectricNodeTemplate::CurrentCalculationNode => {
                // 电流计算节点：输入功率、电压、功率因数，输出计算电流
                graph.add_input_param(node_id, "功率", InputParamKind::ConnectionOrConstant, ElectricDataType::Power, Some(ElectricValueType::Float(0.0)));
                graph.add_input_param(node_id, "电压", InputParamKind::ConnectionOrConstant, ElectricDataType::Voltage, Some(ElectricValueType::Float(220.0)));
                graph.add_input_param(node_id, "功率因数", InputParamKind::ConnectionOrConstant, ElectricDataType::PowerFactor, Some(ElectricValueType::Float(0.8)));
                graph.add_input_param(node_id, "需用系数", InputParamKind::ConnectionOrConstant, ElectricDataType::Coefficient, Some(ElectricValueType::Float(0.8)));
                graph.add_output_param(node_id, "计算电流", ElectricDataType::Current);
            },

            ElectricNodeTemplate::PhaseBalanceNode => {
                // 三相平衡节点：输入A/B/C相功率，输出不平衡度和优化建议
                graph.add_input_param(node_id, "A相功率", InputParamKind::ConnectionOrConstant, ElectricDataType::Power, Some(ElectricValueType::Float(0.0)));
                graph.add_input_param(node_id, "B相功率", InputParamKind::ConnectionOrConstant, ElectricDataType::Power, Some(ElectricValueType::Float(0.0)));
                graph.add_input_param(node_id, "C相功率", InputParamKind::ConnectionOrConstant, ElectricDataType::Power, Some(ElectricValueType::Float(0.0)));
                graph.add_output_param(node_id, "不平衡度", ElectricDataType::Coefficient);
                graph.add_output_param(node_id, "平衡建议", ElectricDataType::String);
            },

            _ => {
                // 默认情况：不添加参数
            }
        }
    }
}

// 提供一个获取所有可用模板的函数
fn all_electric_templates() -> Vec<ElectricNodeTemplate> {
    vec![
        // 配电回路相关节点
        ElectricNodeTemplate::CircuitNode,
        ElectricNodeTemplate::CircuitGroupNode,

        // 配电箱相关节点
        ElectricNodeTemplate::DistributionBoxNode,
        ElectricNodeTemplate::MainDistributionBoxNode,
        ElectricNodeTemplate::SubDistributionBoxNode,

        // 干线系统图相关节点
        ElectricNodeTemplate::MainLineNode,
        ElectricNodeTemplate::FeederLineNode,

        // 电源节点
        ElectricNodeTemplate::PowerSourceNode,

        // 计算节点
        ElectricNodeTemplate::CurrentCalculationNode,
        ElectricNodeTemplate::PhaseBalanceNode,
    ]
}
```
创建电气系统专用的节点类型模板：

```rust
use egui_node_graph::{NodeTemplateTrait, InputParamKind};

// 节点模板定义已移至专门的文档中
// 详细定义请参考：《04节点模板.md》

// 提供一个获取所有可用模板的函数
fn all_electric_templates() -> Vec<ElectricNodeTemplate> {
    vec![
        // 配电回路相关节点
        ElectricNodeTemplate::CircuitNode,
        ElectricNodeTemplate::CircuitGroupNode,

        // 配电箱相关节点
        ElectricNodeTemplate::DistributionBoxNode,
        ElectricNodeTemplate::MainDistributionBoxNode,
        ElectricNodeTemplate::SubDistributionBoxNode,

        // 干线系统图相关节点
        ElectricNodeTemplate::MainLineNode,
        ElectricNodeTemplate::FeederLineNode,

        // 电源节点
        ElectricNodeTemplate::PowerSourceNode,

        // 计算节点
        ElectricNodeTemplate::CurrentCalculationNode,
        ElectricNodeTemplate::PhaseBalanceNode,
    ]
}
```

## 节点模板的主要功能

1. **标准化节点创建**：通过`ElectricNodeTemplate`枚举定义各种电气系统节点类型，确保节点创建的一致性和规范性。

2. **节点分类管理**：实现`CategoryTrait`接口，将节点按功能分类（配电回路、配电箱、干线系统、电源、计算工具等），方便用户在编辑器中查找和使用。

3. **节点属性预配置**：在`NodeTemplateTrait`实现中，为不同类型的节点预设默认属性值（如名称、尺寸、初始数据等），减少用户手动配置的工作量。

4. **统一节点外观定义**：为每种节点类型设置标准尺寸和样式，保证界面的一致性和专业性。

5. **输入输出接口标准化**：通过`build_node`方法，为每种节点类型定义标准的输入输出参数接口，确保节点间数据交互的规范性。

6. **模板管理机制**：提供`all_electric_templates`函数，统一管理所有可用的节点模板，便于扩展和维护。