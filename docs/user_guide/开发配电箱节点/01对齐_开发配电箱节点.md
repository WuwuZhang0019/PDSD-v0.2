# 开发配电箱节点 - 需求对齐文档

## 1. 项目上下文分析

### 1.1 项目结构与技术栈

PDSD (Power Distribution System Diagram) 是一个基于Rust语言开发的配电系统图设计工具，使用egui/eframe构建GUI界面。主要技术栈包括：

- Rust 2024 Edition
- egui 0.32.3 (GUI框架)
- eframe 0.32.3 (应用框架)
- slotmap 1.0.7 (高效ID管理)
- serde 1.0 (序列化)
- thiserror 1.0 (错误处理)

### 1.2 现有项目架构

项目采用分层架构设计：
- **用户界面层**：基于egui/eframe的GUI实现
- **业务逻辑层**：处理用户交互和核心业务逻辑
- **核心库层**：实现电气计算和算法
- **数据层**：管理项目数据和状态

### 1.3 相关现有代码

已完成的相关模块：
- 配电回路节点已实现完成，提供了回路参数定义、验证和电流计算功能
- 基础的节点编辑器框架已搭建完成
- 核心数据结构已设计完成

### 1.4 业务域理解

配电箱是配电系统中的关键组件，负责：
- 管理多个配电回路
- 实现回路的自动编号
- 执行三相平衡优化
- 计算总功率和总电流
- 确定进线保护设备电流整定值

## 2. 需求理解确认

### 2.1 原始需求

根据项目规划和8.2配电箱节点实现文档，配电箱节点需要：

1. 管理多个配电回路节点
2. 实现自动编号功能
3. 实现三相平衡算法
4. 计算总功率和总电流
5. 确定进线保护设备电流整定值
6. 支持在节点编辑器中可视化展示和交互

### 2.2 边界确认

- **功能边界**：
  - 配电箱节点主要管理配电回路节点，不直接管理干线系统
  - 支持最多管理99个回路（考虑编号规则）
  - 仅支持三相配电系统

- **技术边界**：
  - 必须符合egui_node_graph框架的节点接口要求
  - 与已实现的配电回路节点进行集成
  - 使用现有的电气计算库进行电流计算

### 2.3 需求理解

基于现有项目的理解，配电箱节点需要：

1. **数据结构**：
   - 定义包含配电箱名称、总功率、总电流、进线保护设备电流整定值等属性的数据结构
   - 支持序列化和反序列化
   - 实现与egui_node_graph框架兼容的接口

2. **核心功能**：
   - 回路自动编号：根据功率大小或其他规则对回路进行排序和编号
   - 三相平衡：将回路合理分配到L1、L2、L3三相，实现负载平衡
   - 总参数计算：计算配电箱的总功率、总电流
   - 进线保护设备选型：根据总电流确定合适的进线保护设备电流整定值

3. **UI交互**：
   - 在节点编辑器中可视化展示配电箱信息
   - 提供参数输入界面
   - 显示计算结果和三相平衡状态

## 3. 疑问澄清

### 3.1 不确定性问题

1. **回路数量限制**：
   - 问题：配电箱节点最多支持管理多少个回路？
   - 假设：默认支持最多99个回路，编号从1到99

2. **三相平衡算法细节**：
   - 问题：三相平衡的优化目标和允许的不平衡度是多少？
   - 假设：优化目标是使三相负载尽可能均衡，允许的不平衡度为1%

3. **进线保护设备选型标准**：
   - 问题：进线保护设备电流整定值的计算标准是什么？
   - 假设：考虑1.2倍的安全系数，选择标准电流等级

4. **与回路节点的连接方式**：
   - 问题：配电箱节点如何与多个回路节点建立连接？
   - 假设：通过输入端口接收回路数据，可能需要实现动态端口管理

### 3.2 决策点

1. **节点数据结构设计**：
   - 决策：使用结构体封装所有必要字段，实现NodeDataTrait接口
   - 理由：保持与现有回路节点一致的设计模式

2. **算法实现方式**：
   - 决策：采用迭代优化的三相平衡算法
   - 理由：算法复杂度适中，能有效实现负载平衡

3. **错误处理策略**：
   - 决策：使用Result类型和自定义错误类型
   - 理由：与项目现有的错误处理机制保持一致

4. **测试策略**：
   - 决策：实现单元测试和集成测试
   - 理由：确保核心算法正确性和节点功能正常

## 4. 电气计算逻辑

### 4.1 计算公式

1. **总电流计算**：
   - 公式：Ijs = Pe * 1000 / (1.732 * 380 * Cosφ)
   - 说明：Pe为总功率(kW)，Cosφ为功率因数(默认0.85)

2. **进线保护设备电流整定值**：
   - 标准值序列：[100, 125, 160, 200, 250, 315, 400, 500, 630] A
   - 计算公式：I_in = max(标准值序列中 >= Ijs * 1.2 的最小值)

3. **三相平衡评估**：
   - 不平衡度 = 最大相负载与最小相负载之差 / 平均负载
   - 目标不平衡度：< 1%

### 4.2 算法流程

1. **自动编号流程**：
   - 按功率大小排序回路
   - 依次分配编号1, 2, 3, ...

2. **三相平衡流程**：
   - 初始分配：按顺序将回路分配到各相
   - 迭代优化：
     - 计算平均负载
     - 找出负载最大和最小的相
     - 尝试将最大负载相的回路转移到最小负载相
     - 重复直到达到平衡或达到最大迭代次数

## 5. 集成方案

### 5.1 与现有系统集成

- **与节点编辑器集成**：实现NodeDataTrait和NodeTemplateTrait接口
- **与回路节点集成**：通过输入端口接收回路数据
- **与计算引擎集成**：使用现有的电气计算库

### 5.2 数据流向

- 从回路节点接收回路数据
- 处理数据（自动编号、三相平衡、计算总参数）
- 输出处理后的结果和状态信息

## 6. 验收标准

1. **功能验收**：
   - 成功创建配电箱节点
   - 正确管理多个回路节点
   - 自动编号功能正常工作
   - 三相平衡算法有效执行
   - 总参数计算结果正确
   - 进线保护设备选型合理

2. **技术验收**：
   - 代码编译无错误
   - 单元测试通过率100%
   - 符合Rust编码规范
   - 与现有系统集成良好
   - 性能满足要求