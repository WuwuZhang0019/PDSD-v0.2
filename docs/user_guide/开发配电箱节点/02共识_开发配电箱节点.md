# 开发配电箱节点 - 需求共识文档

## 1. 需求描述

基于对「开发配电箱节点」任务的对齐和分析，形成以下明确需求：

### 1.1 主要功能需求

1. **配电箱节点基础功能**：
   - 管理和组织多个配电回路节点
   - 支持在节点编辑器中创建、配置和删除
   - 提供直观的UI界面展示配电箱信息

2. **回路自动编号**：
   - 根据回路功率大小自动排序
   - 按顺序分配编号（从1开始）
   - 支持最多99个回路

3. **三相平衡功能**：
   - 将回路自动分配到L1、L2、L3三相
   - 实现负载平衡优化，目标不平衡度<1%
   - 提供平衡状态可视化展示

4. **电气参数计算**：
   - 计算配电箱总功率
   - 计算总电流（基于三相380V系统）
   - 确定进线保护设备电流整定值

5. **数据连接与传递**：
   - 接收来自配电回路节点的数据
   - 处理和整合数据
   - 输出结果供其他节点使用

### 1.2 非功能需求

1. **性能要求**：
   - 节点数据更新响应时间 < 100ms
   - 三相平衡算法在100次迭代内完成

2. **可用性要求**：
   - 提供清晰的错误提示
   - 支持参数验证
   - 操作直观易用

3. **可靠性要求**：
   - 异常情况处理完善
   - 数据一致性保障

## 2. 技术实现方案

### 2.1 数据结构设计

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DistributionBoxNode {
    pub name: String,          // 配电箱名称
    pub total_power: f64,      // 总功率(kW)
    pub total_current: f64,    // 总电流(A)
    pub incoming_current: f64, // 进线保护设备电流整定值(A)
    pub floor: u32,            // 所在楼层
    pub modules: Vec<String>,  // 包含的模块
    pub phase_loads: [f64; 3], // L1, L2, L3各相负载(kW)
    pub circuits: Vec<CircuitInfo>, // 管理的回路信息
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct CircuitInfo {
    pub circuit_id: String,    // 回路ID
    pub name: String,          // 回路名称
    pub power: f64,            // 回路功率(kW)
    pub current: f64,          // 回路电流(A)
    pub number: u32,           // 自动分配的编号
    pub phase: Option<char>,   // 分配的相(L1/L2/L3)
}
```

### 2.2 核心算法实现

1. **自动编号算法**：
   - 按功率降序排序回路
   - 依次分配从1开始的连续编号

2. **三相平衡算法**：
   - 初始分配：按功率大小依次分配到各相
   - 迭代优化：
     - 计算三相平均负载
     - 找出负载最大和最小的相
     - 尝试将适当的回路从最大负载相转移到最小负载相
     - 重复直到达到平衡条件或最大迭代次数(100次)

3. **电气计算实现**：
   - 总功率：所有回路功率之和
   - 总电流：Ijs = Pe * 1000 / (1.732 * 380 * 0.85)
   - 进线保护设备电流整定值：基于总电流的1.2倍选择标准电流等级

### 2.3 框架集成方案

1. **与egui_node_graph集成**：
   - 实现`NodeDataTrait`接口
   - 实现`NodeTemplateTrait`接口
   - 定义输入和输出端口

2. **UI界面实现**：
   - 实现节点顶部标题栏
   - 实现参数配置界面
   - 实现计算结果显示区域
   - 实现三相负载分布可视化

### 2.4 错误处理策略

1. **定义自定义错误类型**：
   ```rust
   #[derive(Debug, thiserror::Error)]
   pub enum DistributionBoxError {
       #[error("回路数量超出限制: {0}")]
       CircuitCountExceeded(u32),
       #[error("参数无效: {0}")]
       InvalidParameter(String),
       #[error("三相平衡失败")]
       BalanceFailed,
       #[error("计算错误: {0}")]
       CalculationError(String),
   }
   ```

2. **错误处理流程**：
   - 使用`Result<T, DistributionBoxError>`处理可能失败的操作
   - 在UI中显示错误信息
   - 提供错误恢复机制

## 3. 任务边界与限制

### 3.1 功能边界

- **仅管理配电回路节点**：不直接管理干线系统
- **支持最多99个回路**：编号范围1-99
- **仅支持三相380V系统**：暂不支持其他电压等级
- **不包含元器件详细选型**：仅计算进线保护设备电流整定值

### 3.2 技术限制

- **基于现有框架**：必须符合egui_node_graph框架要求
- **与现有系统集成**：使用项目已定义的数据类型和接口
- **Rust语言规范**：严格遵循Rust语言最佳实践

## 4. 验收标准

### 4.1 功能验收标准

1. **节点创建与配置**：
   - 成功创建配电箱节点
   - 正确配置配电箱名称、楼层等基本信息
   - 参数输入验证有效

2. **回路管理**：
   - 成功接收和处理多个回路节点数据
   - 最多支持99个回路
   - 回路信息正确显示

3. **自动编号功能**：
   - 回路按功率大小正确排序
   - 编号从1开始连续分配
   - 编号变更后正确更新

4. **三相平衡功能**：
   - 回路正确分配到L1、L2、L3三相
   - 负载平衡度<1%
   - 平衡结果可视化展示正确

5. **电气计算**：
   - 总功率计算准确
   - 总电流计算准确（与手动计算误差<0.1%）
   - 进线保护设备电流整定值选择合理

### 4.2 技术验收标准

1. **代码质量**：
   - 编译无错误和警告
   - 符合Rust编码规范
   - 通过`cargo clippy`检查
   - 代码结构清晰，注释完整

2. **测试覆盖**：
   - 单元测试覆盖率>90%
   - 测试用例包括正常情况、边界情况和异常情况
   - 所有测试通过

3. **性能测试**：
   - 节点数据更新响应时间<100ms
   - 三相平衡算法在100次迭代内完成

4. **集成测试**：
   - 与配电回路节点集成正常
   - 与节点编辑器框架集成正常
   - 数据传递和处理正确

## 5. 不确定性解决方案

### 5.1 已解决的不确定性

1. **回路数量限制**：
   - 确定限制为99个回路
   - 实现数量检查和错误提示

2. **三相平衡目标**：
   - 确定不平衡度目标<1%
   - 设置最大迭代次数为100次

3. **进线保护设备选型**：
   - 确定使用1.2倍安全系数
   - 标准电流等级序列已明确

4. **数据连接方式**：
   - 使用输入端口接收回路数据
   - 可能需要实现动态端口管理

### 5.2 技术风险及缓解措施

1. **性能风险**：
   - 风险：大量回路时三相平衡算法性能下降
   - 措施：设置最大迭代次数，优化算法实现

2. **数据一致性风险**：
   - 风险：回路数据更新时可能导致不一致
   - 措施：实现数据验证和一致性检查

3. **框架集成风险**：
   - 风险：与egui_node_graph框架集成困难
   - 措施：参考现有回路节点实现，确保接口兼容