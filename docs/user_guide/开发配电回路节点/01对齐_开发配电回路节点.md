# 开发配电回路节点 - 对齐阶段文档

## 1. 项目上下文分析

### 1.1 现有项目结构与技术栈

PDSD (Power Distribution System Diagram) 是一个基于Rust语言开发的配电系统图设计工具，使用egui/eframe构建GUI界面。本项目旨在通过节点编辑器简化建筑电气设计过程中的配电系统图设计。

主要技术栈：
- Rust 2024 Edition
- egui 0.32.3 (GUI框架)
- eframe 0.32.3 (应用框架)
- slotmap 1.0.7 (高效ID管理)
- serde 1.0 (序列化)
- thiserror 1.0 (错误处理)

### 1.2 现有代码模式与框架

项目使用egui_node_graph库作为节点编辑器的基础框架，该库提供了以下核心接口：

- `WidgetValueTrait`: 用于为节点图的不同类型绘制自定义内联小部件
- `DataTypeTrait`: 定义数据类型的视觉表示方式
- `NodeDataTrait`: 允许自定义节点绘制的某些方面
- `NodeTemplateTrait`: 允许自定义节点模板，描述可添加到图中的节点类型

### 1.3 业务域与数据模型

电气计算已实现在`src/core_lib/algorithm/current_calculation.rs`中，包括：
- 单相电流计算：Ijs = Pe * Kx / U / Cos（U=0.22kV）
- 三相电流计算：Ijs = Pe * Kx / U / Cos / √3（U=0.38kV）

## 2. 需求理解确认

### 2.1 原始需求

根据项目说明文档中的功能规划，配电回路设计模块需要实现：
- 自动电流计算
- 智能元器件选型（断路器、线缆规格）
- 回路用途识别

### 2.2 边界确认

本次任务范围：
- 开发配电回路节点的基础实现
- 实现与电流计算模块的集成
- 支持回路的基本参数配置与显示
- 支持节点间的数据传递

不包括：
- 完整的智能元器件选型逻辑
- 复杂的回路用途识别算法
- 高级的UI交互功能

### 2.3 需求理解

配电回路节点是整个系统中的基础节点类型，用于表示电气设计中的配电回路。每个配电回路节点应支持配置基本参数（如额定功率、需要系数、功率因数等），并能根据这些参数计算电流值。节点应提供输入和输出端口，以便与其他节点（如配电箱节点）进行连接和数据交换。

## 3. 智能决策策略

### 3.1 歧义与不确定性识别

- **回路节点参数范围与验证规则**：需要确定各个参数的有效范围和验证规则
- **回路节点与配电箱节点的数据交互格式**：需要明确数据传递的具体格式和内容
- **回路类型支持**：是否需要支持多种类型的回路（如照明回路、动力回路等）

### 3.2 结构化问题清单（按优先级排序）

1. 配电回路节点需要包含哪些具体参数？（必填参数和可选参数）
2. 如何定义节点的输入和输出端口？
3. 如何处理和显示计算结果？
4. 是否需要支持不同类型的配电回路？
5. 如何与其他节点类型（如配电箱节点）进行交互？

## 4. 关键决策点

### 4.1 节点参数设计

根据电气计算需求，配电回路节点应至少包含以下参数：
- 回路名称/编号
- 额定功率(Pe)
- 需要系数(Kx)
- 功率因数(Cos)
- 电压类型（单相/三相）

### 4.2 数据传递机制

采用强类型的数据传递机制，确保节点间的数据一致性和类型安全。使用现有的DataTypeTrait实现数据类型的视觉区分。

### 4.3 错误处理策略

使用项目现有的错误处理机制（基于thiserror库），对参数验证和计算过程中可能出现的错误进行捕获和处理。

## 5. 项目特性规范对齐

本次开发任务与项目特性规范保持一致，遵循：
- Rust语言规范和最佳实践
- 项目的分层架构设计
- 代码、测试和文档的质量标准
- 与现有组件的集成要求

## 6. 初步技术方案

基于对项目的理解，初步技术方案如下：

1. 创建`CircuitNode`结构体，实现`NodeDataTrait`接口
2. 定义回路相关的数据类型和参数
3. 集成已有的电流计算功能
4. 实现节点的UI展示和交互逻辑
5. 定义节点模板，使其可在节点编辑器中创建和配置

## 7. 验收标准

- 能够在节点编辑器中创建配电回路节点
- 能够配置回路的基本参数
- 能够根据参数计算电流值
- 节点能够与其他节点进行连接
- 数据能够在节点间正确传递
- 代码通过编译检查和基本测试