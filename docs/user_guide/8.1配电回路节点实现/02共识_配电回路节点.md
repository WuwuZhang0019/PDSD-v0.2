# 配电回路节点功能共识文档

## 1. 明确的需求描述

开发配电回路节点功能，作为系统的基本构成单元，支持以下核心特性：

1. **回路类型管理**：支持单相和三相两种电路类型
2. **多维度属性**：包含功率、电压、电流、相序、回路编号等电气参数
3. **智能计算**：自动计算工作电流和衍生电流值
4. **自动选型**：根据计算结果自动选择元器件规格和线缆规格
5. **分类管理**：按回路用途（照明、动力、空调等）进行分类
6. **可视化展示**：在节点编辑器中直观展示和编辑回路信息

## 2. 技术实现方案

### 2.1 数据结构设计

```rust
// 在 core_lib/data_types 目录下创建 circuit_node.rs

// 回路类型枚举#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize)]
pub enum CircuitType {
    /// 单相回路
    SinglePhase,
    /// 三相回路
    ThreePhase,
}

// 回路用途枚举#[derive(Debug, Clone, PartialEq, Eq, Serialize, Deserialize)]
pub enum CircuitPurpose {
    /// 照明回路
    Lighting,
    /// 动力回路
    Power,
    /// 空调回路
    HVAC,
    /// 特殊用途回路
    Special,
    /// 自定义回路
    Custom(String),
}

// 配电回路节点属性#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct CircuitNodeProperties {
    /// 回路类型
    pub circuit_type: CircuitType,
    /// 回路功率 (kW)
    pub power: f64,
    /// 电压值 (V)
    pub voltage: f64,
    /// 功率因数
    pub power_factor: f64,
    /// 需用系数
    pub demand_factor: f64,
    /// 计算电流 (A)
    pub current: f64,
    /// 1.1倍计算电流
    pub current_1_1x: f64,
    /// 1.25倍计算电流
    pub current_1_25x: f64,
    /// 回路用途
    pub purpose: CircuitPurpose,
    /// 元器件类型
    pub component_type: String,
    /// 元器件电流整定值
    pub component_current: f64,
    /// 线缆规格
    pub cable_spec: String,
    /// 相序标识
    pub phase: Option<char>,
    /// 回路编号
    pub circuit_number: u32,
    /// 回路名称
    pub circuit_name: String,
}

impl Default for CircuitNodeProperties {
    fn default() -> Self {
        Self {
            circuit_type: CircuitType::SinglePhase,
            power: 1.0,
            voltage: 220.0,
            power_factor: 0.85,
            demand_factor: 1.0,
            current: 0.0,
            current_1_1x: 0.0,
            current_1_25x: 0.0,
            purpose: CircuitPurpose::Power,
            component_type: "微型断路器".to_string(),
            component_current: 16.0,
            cable_spec: "BV-2.5mm²".to_string(),
            phase: Some('L'),
            circuit_number: 1,
            circuit_name: "新建回路".to_string(),
        }
    }
}
```

### 2.2 业务逻辑实现

```rust
// 在 editor/business 目录下创建 circuit_node.rs

use crate::core_lib::data_types::circuit_node::{CircuitType, CircuitPurpose, CircuitNodeProperties};
use crate::editor::business::{PowerGraphNode, NodeType};
use crate::editor::data_types::{DataType, UIValueType};

// 扩展 PowerGraphNode 以支持回路节点impl PowerGraphNode {
    /// 创建新的回路节点
    pub fn new_circuit(properties: CircuitNodeProperties) -> Self {
        let node_type = match properties.circuit_type {
            CircuitType::SinglePhase => NodeType::SinglePhaseCircuit,
            CircuitType::ThreePhase => NodeType::ThreePhaseCircuit,
        };
        
        Self {
            node_type,
            label: properties.circuit_name.clone(),
            user_data: properties,
            // 其他字段...
        }
    }
    
    /// 计算电流
    pub fn calculate_circuit_current(&mut self) {
        if let Some(properties) = self.user_data.downcast_mut::<CircuitNodeProperties>() {
            match properties.circuit_type {
                CircuitType::SinglePhase => {
                    // 单相电流计算：I = P * Kx / (U * Cosφ)
                    properties.current = properties.power * 1000.0 * properties.demand_factor 
                        / (properties.voltage * properties.power_factor);
                },
                CircuitType::ThreePhase => {
                    // 三相电流计算：I = P * Kx / (√3 * U * Cosφ)
                    properties.current = properties.power * 1000.0 * properties.demand_factor 
                        / (1.732 * properties.voltage * properties.power_factor);
                },
            }
            
            // 计算衍生电流值
            properties.current_1_1x = properties.current * 1.1;
            properties.current_1_25x = properties.current * 1.25;
        }
    }
    
    /// 智能选型
    pub fn select_circuit_components(&mut self) {
        if let Some(properties) = self.user_data.downcast_mut::<CircuitNodeProperties>() {
            // 选择元器件电流整定值
            properties.component_current = Self::select_component_current(properties.current_1_1x);
            
            // 选择元器件类型
            properties.component_type = Self::select_component_type(&properties.purpose);
            
            // 选择线缆规格
            properties.cable_spec = Self::select_cable_spec(properties.current);
        }
    }
    
    /// 选择元器件电流整定值
    fn select_component_current(calculated_current: f64) -> f64 {
        let standard_values = [1.0, 2.0, 4.0, 6.0, 10.0, 16.0, 20.0, 25.0, 32.0, 40.0, 50.0, 63.0, 80.0, 100.0, 125.0];
        
        for &value in &standard_values {
            if value >= calculated_current {
                return value;
            }
        }
        
        *standard_values.last().unwrap() // 返回最大的标准值
    }
    
    /// 选择元器件类型
    fn select_component_type(purpose: &CircuitPurpose) -> String {
        match purpose {
            CircuitPurpose::Lighting => "微型断路器(照明)".to_string(),
            CircuitPurpose::Power => "微型断路器(动力)".to_string(),
            CircuitPurpose::HVAC => "剩余电流保护器".to_string(),
            CircuitPurpose::Special => "专用保护电器".to_string(),
            CircuitPurpose::Custom(s) => format!("自定义({})", s),
        }
    }
    
    /// 选择线缆规格
    fn select_cable_spec(current: f64) -> String {
        match current {
            x if x <= 6.0 => "BV-2.5mm²".to_string(),
            x if x <= 10.0 => "BV-4mm²".to_string(),
            x if x <= 16.0 => "BV-6mm²".to_string(),
            x if x <= 25.0 => "BV-10mm²".to_string(),
            x if x <= 32.0 => "BV-16mm²".to_string(),
            x if x <= 40.0 => "BV-25mm²".to_string(),
            x if x <= 63.0 => "BV-35mm²".to_string(),
            _ => "BV-50mm²".to_string(),
        }
    }
}
```

### 2.3 节点模板实现

```rust
// 在 editor/business/node_templates.rs 中添加

// 单相回路节点模板impl ElectricNodeTemplate {
    pub fn single_phase_circuit_template() -> Self {
        let mut template = Self::new(
            "single_phase_circuit".to_string(),
            "单相回路".to_string(),
            "circuit".to_string(),
            NodeType::SinglePhaseCircuit,
        );
        
        // 添加输入参数
        template.add_input("power", "功率 (kW)", DataType::Float, UIValueType::Float(1.0));
        template.add_input("voltage", "电压 (V)", DataType::Float, UIValueType::Float(220.0));
        template.add_input("power_factor", "功率因数", DataType::Float, UIValueType::Float(0.85));
        template.add_input("demand_factor", "需用系数", DataType::Float, UIValueType::Float(1.0));
        
        // 添加输出参数
        template.add_output("current", "计算电流 (A)", DataType::Float);
        template.add_output("component_current", "元器件电流 (A)", DataType::Float);
        template.add_output("cable_spec", "线缆规格", DataType::String);
        
        template
    }
    
    pub fn three_phase_circuit_template() -> Self {
        let mut template = Self::new(
            "three_phase_circuit".to_string(),
            "三相回路".to_string(),
            "circuit".to_string(),
            NodeType::ThreePhaseCircuit,
        );
        
        // 添加输入参数
        template.add_input("power", "功率 (kW)", DataType::Float, UIValueType::Float(3.0));
        template.add_input("voltage", "电压 (V)", DataType::Float, UIValueType::Float(380.0));
        template.add_input("power_factor", "功率因数", DataType::Float, UIValueType::Float(0.85));
        template.add_input("demand_factor", "需用系数", DataType::Float, UIValueType::Float(1.0));
        
        // 添加输出参数
        template.add_output("current", "计算电流 (A)", DataType::Float);
        template.add_output("component_current", "元器件电流 (A)", DataType::Float);
        template.add_output("cable_spec", "线缆规格", DataType::String);
        
        template
    }
}
```

### 2.4 数据类型扩展

```rust
// 在 editor/data_types.rs 中添加相关数据类型

// 扩展 DataType 枚举增加回路相关类型
#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]
pub enum DataType {
    // 现有类型...
    Circuit,
    CircuitPurpose,
    ComponentType,
    CableSpec,
}

// 扩展 NodeType 枚举
#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]
pub enum NodeType {
    // 现有类型...
    SinglePhaseCircuit,
    ThreePhaseCircuit,
}
```

## 3. 技术约束

1. 严格遵循 Rust 语言规范和项目代码风格
2. 使用泛型和 trait 实现类型安全
3. 与现有系统保持一致的错误处理机制
4. 确保所有计算符合电气规范
5. 支持序列化和反序列化
6. 与 egui_node_graph 框架兼容

## 4. 集成方案

1. **数据层集成**：通过 `Any` trait 实现数据类型的灵活存储和转换
2. **UI层集成**：实现自定义节点视图，支持回路属性的编辑
3. **计算层集成**：与 `CurrentCalculationEngine` 协同工作
4. **节点系统集成**：在 `all_electric_templates()` 函数中注册回路节点模板

## 5. 验收标准

1. ✅ 实现完整的配电回路节点数据结构
2. ✅ 支持单相和三相两种回路类型
3. ✅ 实现准确的电流计算功能
4. ✅ 实现智能元器件和线缆选型功能
5. ✅ 与现有节点系统无缝集成
6. ✅ 支持节点属性的编辑和保存
7. ✅ 计算结果符合电气规范标准
8. ✅ 通过单元测试验证计算准确性